# Password Reset Flow - Complete Setup

## ✅ Current Configuration

### Website Reset Password Page
- **URL**: `https://energyvehiclealliance.com/reset-password`
- **Route**: `/reset-password` (Next.js App Router)
- **File**: `app/reset-password/page.tsx`

### Supabase Edge Functions
1. **Send Reset Email**: `https://ajirbalenvswlppqpqot.supabase.co/functions/v1/send-reset-email`
   - Called from mobile app when user requests password reset
   - Sends email via MailerSend with reset link

2. **Reset Password**: `https://ajirbalenvswlppqpqot.supabase.co/functions/v1/reset-password`
   - Called from website reset page when user submits new password
   - Updates password in Supabase

## Complete Flow

```
1. User in Mobile App
   ↓
2. Taps "Forgot Password" → Enters email → Taps "Send Link"
   ↓
3. Mobile App calls: POST /send-reset-email
   Body: { "email": "user@example.com" }
   ↓
4. Edge Function:
   - Generates reset token
   - Stores token in Supabase
   - Triggers MailerSend email
   ↓
5. MailerSend sends email with link:
   https://energyvehiclealliance.com/reset-password?token=abc123
   ↓
6. User clicks email link
   ↓
7. Opens: https://energyvehiclealliance.com/reset-password?token=abc123
   ↓
8. User enters new password on website
   ↓
9. Website calls: POST /reset-password
   Body: { "token": "abc123", "password": "NewPassword123!" }
   ↓
10. Edge Function validates token and updates password in Supabase
   ↓
11. Success message shown, redirects to home page
```

## Website Reset Page Configuration

### Endpoint
```typescript
const SUPABASE_ENDPOINT = 'https://ajirbalenvswlppqpqot.supabase.co/functions/v1/reset-password'
```

### Request Format
```json
{
  "token": "reset-token-from-url",
  "password": "NewPassword123!"
}
```

### Response Handling
- **Success**: Shows success message, redirects after 3 seconds
- **Error**: Displays error message from server

## Mobile App Configuration

### Endpoint
```
https://ajirbalenvswlppqpqot.supabase.co/functions/v1/send-reset-email
```

### Request Format
```json
{
  "email": "user@example.com"
}
```

### Email Link Format
MailerSend template should use:
```
https://energyvehiclealliance.com/reset-password?token={{token}}
```

## Verification Checklist

- ✅ Reset password page built at `/reset-password`
- ✅ Page reads token from URL query parameter
- ✅ Page POSTs to Supabase Edge Function
- ✅ Page handles success/error responses
- ✅ Page is mobile-responsive
- ✅ Page has password validation
- ✅ Page redirects after success
- ✅ No Supabase built-in password reset calls in website code
- ⚠️ Mobile app needs to call Edge Function (not Supabase built-in)

## Important Notes

1. **Disable Supabase Default Emails**: In Supabase dashboard → Authentication → Email Templates → Disable password reset emails

2. **All Password Resets Go Through**:
   - Mobile app → Edge Function → MailerSend → Website reset page → Edge Function → Supabase

3. **No Direct Supabase Auth Calls**: The website and mobile app should NOT use `supabase.auth.resetPasswordForEmail()` - only use the Edge Functions

4. **Token Handling**: Tokens are generated by the Edge Function and passed via URL query parameter to the website

## Testing

1. Test from mobile app: Request password reset
2. Verify MailerSend email received
3. Click email link: Should open `https://energyvehiclealliance.com/reset-password?token=...`
4. Enter new password: Should submit to Edge Function
5. Verify password updated in Supabase
6. Verify success message and redirect

## Status

✅ **Website**: Fully configured and ready
⚠️ **Mobile App**: Needs to be updated to call Edge Function (see `MOBILE_APP_FORGOT_PASSWORD_UPDATE.md`)

